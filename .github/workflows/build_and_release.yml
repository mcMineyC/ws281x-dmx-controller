name: Build and Release DMX Receiver Sketches

on:
  workflow_dispatch:
    inputs:
      led_count:
        description: "Number of LEDs"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dmx_start: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    steps:
      - uses: actions/checkout@v4

      # Build RGB version
      - name: Prepare RGB sketch
        run: |
          cp receiver_rgb/receiver_rgb.inor receiver_rgb/receiver_rgb.ino
          sed -i "s/<#NUMPIXELS#>/${{ github.event.inputs.led_count }}/g" receiver_rgb/receiver_rgb.ino
          sed -i "s/<#DMXADDRESS#>/${{ matrix.dmx_start }}/g" receiver_rgb/receiver_rgb.ino

      # - name: Compile RGB sketch
      #   uses: arduino/compile-sketches@v1.1.2
      #   with:
      #     sketch-paths: |
      #       - receiver_rgb
      #     fqbn: arduino:avr:uno
      #     libraries: |
      #       DMXSerial

      # Build RGBW version
      - name: Prepare RGBW sketch
        run: |
          cp receiver_rgbw/receiver_rgbw.inor receiver_rgbw/receiver_rgbw.ino
          sed -i "s/<#NUMPIXELS#>/${{ github.event.inputs.led_count }}/g" receiver_rgbw/receiver_rgbw.ino
          sed -i "s/<#DMXADDRESS#>/${{ matrix.dmx_start }}/g" receiver_rgbw/receiver_rgbw.ino

      - name: Compile sketches
        uses: arduino/compile-sketches@v1.1.2
        with:
          sketch-paths: |
            - receiver_rgbw
            - receiver_rgb
          fqbn: arduino:avr:uno
          libraries: |
            DMXSerial

      - name: Rename RGB output binary
        run: |
          mv receiver_rgb/build/receiver_rgb.ino.hex \
             receiver_rgb/build/receiver_rgb_${{ matrix.dmx_start }}_${{ github.event.inputs.led_count }}leds.hex
      - name: Upload RGB build artifact
        uses: actions/upload-artifact@v4
        with:
          name: receiver_rgb_${{ matrix.dmx_start }}_${{ github.event.inputs.led_count }}
          path: receiver_rgb/build/receiver_rgb_${{ matrix.dmx_start }}_${{ github.event.inputs.led_count }}.hex

      - name: Rename RGBW output binary
        run: |
          mv receiver_rgbw/build/receiver_rgbw.ino.hex \
             receiver_rgbw/build/receiver_rgbw_${{ matrix.dmx_start }}_${{ github.event.inputs.led_count }}leds.hex
      - name: Upload RGBW build artifact for DMX start ${{ matrix.dmx_start }}
        uses: actions/upload-artifact@v4
        with:
          name: receiver_rgbw_${{ matrix.dmx_start }}_${{ github.event.inputs.led_count }}
          path: receiver_rgbw/build/receiver_rgbw_${{ matrix.dmx_start }}_${{ github.event.inputs.led_count }}.hex

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all RGB build artifacts
        uses: actions/download-artifact@v4
        with:
          path: rgb_builds

      - name: Download all RGBW build artifacts
        uses: actions/download-artifact@v4
        with:
          path: rgbw_builds

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.led_count }}
          name: "DMX Receiver Builds for ${{ github.event.inputs.led_count }} LEDs"
          files: |
            rgb_builds/receiver_rgb_*_${{ github.event.inputs.led_count }}.hex
            rgbw_builds/receiver_rgbw_*_${{ github.event.inputs.led_count }}.hex
